<html>
    <head>
        <link rel="stylesheet" href="../node_modules/litegraph.js/css/litegraph.css">
        <style>
            html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #mycanvas {
                width: 100%;
                height: 100%;
            }

            #overlay {
                position: absolute;
                width: 100%;
                height: 100%;
                background-color: black;
                opacity: 0.5;
                z-index: 20;
            }

            #overlay-loader {
                top: 50%;
                left: 50%;
                position: absolute;
                transform: translate(-50%, -50%);
            }

            #overlay-loader > .preloader-wrapper {
                width: 128px;
                height: 128px;
                opacity: 1;
            }

            #helpBox {
                position: absolute;
                width: 100%;
                height: 10%;
                background-color: #00000069;
                z-index: 18;
                bottom: 0;
                text-align: center;
                color: white;
                font-family: "Courier New", monospace;
                font-size: 20px;
            }

            #helpBox .helpBox-shortcut {
                height: 80%;
                width: auto;
                padding-top: 5px;
            }

            #helpBox .keypics {
                height: 100%;
                width: auto;
                vertical-align: middle;
            }
        </style>
    </head>
    <body>
        <div id="overlay">
            <div id="overlay-loader">
                <img src="../assets/images/spinner.svg">
            </div>
        </div>
        <div id="helpBox">
            <div class="helpBox-shortcut">
                <i class="keypics" data-type="mouse" data-color="dark" data-label="x2" data-fontFamily="RobotoMono">left</i>&nbsp;to search for elements to add
            </div>
        </div>
        <canvas id='mycanvas' width='1920' height='1080'></canvas>
        <script>
            const {ipcRenderer} = require("electron");
            const {Menu, getCurrentWindow, getGlobal} = require("electron").remote;
            const {LiteGraph, LGraph, LGraphCanvas} = require("../node_modules/litegraph.js/build/litegraph");
            const NodeGenerator = require("../js/nodeGenerator");
            const CodeGenerator = require("../js/codeGenerator");
            const History = require("../js/history");
            const analytics = getGlobal("analytics");
            const $ = require("jquery");
            const Sentry = require("@sentry/electron");
            const KeyPics = require("key.pics");

            let projectInfo = {};

            let history = new History();
            history.pause();

            var graph = new LGraph();
            graph.onNodeAdded = function () {
                console.debug("[HISTORY] onNodeAdded");
                if (history) {
                    history.track(JSON.stringify(graph.serialize()));

                    console.log(history);

                    // hide inside the history's timeout to prevent hiding it instantly
                    if (!history.paused) {
                        $("#helpBox").hide();
                    }
                }
            };
            graph.onNodeRemoved = function () {
                console.debug("[HISTORY] onNodeRemoved");
                if (history) {
                    history.track(JSON.stringify(graph.serialize()));

                    console.log(history)
                }
            };
            graph.onConnectionChange = function () {
                console.debug("[HISTORY] onConnectionChange");
                if (history) {
                    history.track(JSON.stringify(graph.serialize()));

                    console.log(history)
                }
            };

            LGraphCanvas.search_filter = true;
            LGraphCanvas.search_limit = 100;
            var canvas = new LGraphCanvas("#mycanvas", graph);
            console.log(canvas);

            $(document).ready(function () {
                Sentry.init({
                    dsn: 'https://6d56f92bc4f84e44b66950ed04e92704@sentry.io/1309246',
                    beforeSend(event) {
                        // Check if it is an exception, if so, show the report dialog
                        if (event.exception) {
                            Sentry.showReportDialog();
                        }
                        return event;
                    }
                });

                analytics.event("Graph", "Open Editor").pageview("/graph", "", "Graph").send();
            })

            ipcRenderer.send("getProjectInfo");

            window.addEventListener("resize", function () {
                canvas.resize();
            });
            $("body")[0].addEventListener("keydown", canvas.processKey.bind(canvas));
            canvas.resize();

            console.log("Initializing Bukkit Node generator...")
            NodeGenerator.init().then(() => {
                ipcRenderer.send("getGraphData");

                graph.start(100);
            });


            function addBukkitNode(className, classType) {
                let nodeName = NodeGenerator.getOrCreateBukkitClassNode(className, classType);
                console.log(nodeName);
                if (!nodeName) return;
                let node = LiteGraph.createNode(nodeName);
                if (!node) return;
                console.log(node)
                graph.add(node);
            }

            function generateCode() {
                $("#overlay").fadeIn();
                CodeGenerator.generateClassCode(graph, projectInfo).then((code) => {
                    ipcRenderer.send("codeGenerated", {code: code, compile: false, pack: false});
                });
            }


            function generateCodeCompilePackage() {
                $("#overlay").fadeIn();
                CodeGenerator.generateClassCode(graph, projectInfo).then((code) => {
                    ipcRenderer.send("codeGenerated", {code: code, compile: true, pack: true});
                });
            }


            function compile() {
                $("#overlay").fadeIn();
                ipcRenderer.send("codeGenerated", {code: null, compile: true, pack: false});
            }

            function pack() {
                $("#overlay").fadeIn();
                ipcRenderer.send("codeGenerated", {code: null, compile: false, pack: true});
            }

            function saveGraph() {
                $("#overlay").fadeIn();
                makeThumbnail();
                ipcRenderer.send("saveGraphData", graph.serialize());
            }

            function saveGraphAndClose() {
                $("#overlay").fadeIn();
                makeThumbnail();
                ipcRenderer.send("saveGraphDataAndClose", graph.serialize());
            }

            function makeThumbnail() {
                let img = canvas.canvas.toDataURL("image/jpeg");
                ipcRenderer.send("saveThumbnail", img);
            }

            function undo() {
                console.log("canUndo: " + history.canUndo());
                history.pause();
                if (history.canUndo()) {
                    let undone = history.undo();
                    console.log(undone)
                    graph.configure(JSON.parse(undone))
                }
                history.unpause();
                console.log(history)
            }

            function redo() {
                console.log("canRedo: " + history.canRedo());
                history.pause();
                if (history.canRedo()) {
                    let redone = history.redo();
                    console.log(redone)
                    graph.configure(JSON.parse(redone));
                }
                history.unpause();
                console.log(history)
            }

            getCurrentWindow().setMenu(Menu.buildFromTemplate([
                {
                    label: "File",
                    submenu: [
                        {
                            label: "New", role: "new", click: () => {
                                ipcRenderer.send("showCreateNewProject");
                            }
                        },
                        {
                            label: "Open", role: "open", click: () => {
                                ipcRenderer.send("showOpenProject");
                            }
                        },
                        {
                            type: "separator"
                        },
                        {
                            label: "Save",
                            role: "save",
                            accelerator: "CommandOrControl+S",
                            click: () => {
                                saveGraph()
                            }
                        },
                        {
                            type: "separator"
                        },
                        {
                            role: "toggledevtools"
                        },
                        {
                            type: "separator"
                        },
                        {
                            label: "Close Project",
                            click: () => {
                                saveGraphAndClose();
                            }
                        }
                    ]
                },
                {
                    label: "Edit",
                    submenu: [
                        {
                            label: "Undo",
                            accelerator: "CommandOrControl+Z",
                            click: () => undo()
                        },
                        {
                            label: "Redo",
                            accelerator: "CommandOrControl+Y",
                            click: () => redo()
                        },
                        {
                            type: "separator"
                        },
                        {
                            label: "Edit Project Information", click: () => {
                                ipcRenderer.send("openProjectInfoEditor");
                            }
                        },
                        {
                            type: "separator"
                        },
                        {
                            label: "Close",
                            click: () => {
                                saveGraphAndClose();
                            }
                        }
                    ]
                },
                {
                    label: "Compile",
                    submenu: [
                        {
                            label: "Generate Code, Compile, Package", click: () => {
                                generateCodeCompilePackage();
                            }
                        },
                        {
                            type: "separator"
                        },
                        {
                            label: "Open output directory", click: () => {
                                ipcRenderer.send("openOutputDir");
                            }
                        },
                        {
                            type: "separator"
                        },
                        {
                            label: "Generate Code", click: () => {
                                generateCode();
                            }
                        },
                        {
                            label: "Compile", click: () => {
                                compile();
                            }
                        },
                        {
                            label: "Package", click: () => {
                                pack();
                            }
                        }
                    ]
                },
                {
                    label: "Run",
                    submenu: [
                        {
                            label: "Start Server", click: () => {
                                ipcRenderer.send("startServer");
                            }
                        },
                        {
                            label: "Stop Server", click: () => {
                                ipcRenderer.send("stopServer");
                            }
                        },
                        {
                            type: "separator"
                        },
                        {
                            label: "Reload Plugin", click: () => {
                                ipcRenderer.send("reloadPlugin");
                            }
                        }
                    ]
                }
            ]))

            ipcRenderer.on("projectInfo", function (event, arg) {
                projectInfo = arg;
                console.log("Project:")
                console.log(arg);
            });
            ipcRenderer.on("graphData", function (event, arg) {
                if (!arg) {
                    console.warn("Empty graph data")
                    return;
                }
                if (graph && arg.nodes) {
                    graph.configure(arg);
                }
                $("#overlay").fadeOut();

                history.unpause();
                history.track(JSON.stringify(graph.serialize()));
            })
            ipcRenderer.on("generateDone", function (event, arg) {
                $("#overlay").fadeOut();
            })
            ipcRenderer.on("generateError", function (event, arg) {
                $("#overlay").fadeOut();
                console.error(arg);
            });
            ipcRenderer.on("graphDataSaved", function (event, arg) {
                $("#overlay").fadeOut();
            })

            ipcRenderer.on("debugCall", function (event, arg) {
                console.log("debugCall", arg);
                let node = graph.getNodeById(arg.node);
                if (node) {
                    console.log(node);
                    if (arg.type === "exec") {
                        if (node.inputs) {
                            // Trace back the inputs, since the node calls the debug on itself, but litegraph wants the trigger on the originating node
                            for (let i = 0; i < node.inputs.length; i++) {
                                let input = node.inputs[i];
                                console.log(input)
                                if (!input) continue;
                                if (input.type === "@EXEC") {
                                    let linkInfo = input.link ? graph.links[input.link] : null;
                                    if (linkInfo) {
                                        let originNode = graph.getNodeById(linkInfo.origin_id);
                                        if (originNode) {
                                            console.log("Trigger slot", linkInfo.origin_slot, "in node", linkInfo.origin_id, " - triggered by", node.id);
                                            originNode.triggerSlot(linkInfo.origin_slot);
                                        }
                                    }
                                }
                            }
                        }
                        // if (node.outputs) {
                        //     for (let o = 0; o < node.outputs.length; o++) {
                        //         if (node.outputs[o].type === "@EXEC") {
                        //             node.triggerSlot(o)
                        //         }
                        //     }
                        // }
                    }
                }
            })

            ipcRenderer.on("highlightNode", function (event, arg) {
                let node = graph.getNodeById(arg.node);
                if (node) {
                    console.log(node);
                    canvas.selectNode(node);
                    canvas.centerOnNode(node);
                    canvas.setZoom(2);

                    analytics.event("Graph", "Highlight Node").send();
                }
            })

            // HelpBox timeout
            setTimeout(function () {
                $("#helpBox").hide();
            }, 60000);
        </script>
    </body>
</html>