<html>
    <head>
        <link rel="stylesheet" href="../node_modules/litegraph.js/css/litegraph.css">
        <link rel="stylesheet" href="../css/preloader.css">
        <style>
            html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #overlay {
                position: absolute;
                width: 100%;
                height: 100%;
                background-color: black;
                opacity: 0.5;
                z-index: 20;
            }

            #overlay-loader {
                top: 50%;
                left: 50%;
                position: absolute;
                transform: translate(-50%, -50%);
            }

            #overlay-loader > .preloader-wrapper {
                width: 128px;
                height: 128px;
                opacity: 1;
            }
        </style>
    </head>
    <body>
        <div id="overlay">
            <div id="overlay-loader">
                <div class="preloader-wrapper big active">
                    <div class="spinner-layer spinner-blue-only">
                        <div class="circle-clipper left">
                            <div class="circle"></div>
                        </div>
                        <div class="gap-patch">
                            <div class="circle"></div>
                        </div>
                        <div class="circle-clipper right">
                            <div class="circle"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <canvas id='mycanvas' width='1920' height='1080'></canvas>
        <script>
            const {ipcRenderer} = require("electron");
            const {Menu, getCurrentWindow} = require("electron").remote;
            const {LiteGraph, LGraph, LGraphCanvas} = require("../node_modules/litegraph.js/build/litegraph");
            const NodeGenerator = require("../js/nodeGenerator");
            const CodeGenerator = require("../js/codeGenerator");
            const $ = require("jquery");
            // LiteGraph.debug=true;

            var graph = new LGraph();

            var canvas = new LGraphCanvas("#mycanvas", graph);
            console.log(canvas);

            var projectInfo = {};
            ipcRenderer.send("getProjectInfo");

            graph.onNodeAdded = function (node) {
                console.log(node);
            };
            canvas.onNodeSelected = function (node) {
                console.log(node)
            }

            function resizeCanvas() {
                let width = window.innerWidth;
                let height = window.innerHeight;

                canvas.resize(width, height);
            }

            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();

            console.log("Initializing Bukkit Node generator...")
            NodeGenerator.init().then(() => {

                // graph.addGlobalInput("Plugin", "org.bukkit.plugin.JavaPlugin");

                for (let n in NodeGenerator.getClassesByName()) {
                    NodeGenerator.getOrCreateBukkitClassNode(n)
                }

                let methods = NodeGenerator.getMethods();
                for (let i = 0; i < methods.length; i++) {
                    NodeGenerator.getOrCreateBukkitMethodNode(methods[i])
                }

                console.log(NodeGenerator.getClassesByName())


                // addBukkitNode("org.bukkit.event.player.PlayerJoinEvent","event")


                ipcRenderer.send("getGraphData");

            })

            function addBukkitNode(className, classType) {
                let nodeName = NodeGenerator.getOrCreateBukkitClassNode(className, classType);
                console.log(nodeName);
                if (!nodeName) return;
                let node = LiteGraph.createNode(nodeName);
                if (!node) return;
                console.log(node)
                graph.add(node);
            }

            function generateCode() {
                let code = CodeGenerator.generateClassCode(graph, projectInfo);
                ipcRenderer.send("codeGenerated", {code: code, compile: false, pack: false});
            }


            function generateCodeCompilePackage() {
                let code = CodeGenerator.generateClassCode(graph, projectInfo);
                ipcRenderer.send("codeGenerated", {code: code, compile: true, pack: true});
            }


            function compile() {
                ipcRenderer.send("codeGenerated", {code: null, compile: true, pack: false});
            }

            function pack() {
                ipcRenderer.send("codeGenerated", {code: null, compile: false, pack: true});
            }

            function saveGraph() {
                ipcRenderer.send("saveGraphData", graph.serialize());
            }

            function saveGraphAndClose() {
                ipcRenderer.send("saveGraphDataAndClose", graph.serialize());
            }

            getCurrentWindow().setMenu(Menu.buildFromTemplate([
                {
                    label: "File",
                    submenu: [
                        {
                            label: "New", role: "new", click: () => {
                                ipcRenderer.send("showCreateNewProject");
                            }
                        },
                        {
                            label: "Open", role: "open", click: () => {
                                ipcRenderer.send("showOpenProject");
                            }
                        },
                        {
                            type: "separator"
                        },
                        {
                            label: "Save",
                            role: "save",
                            accelerator: "CommandOrControl+S",
                            click: () => {
                                saveGraph()
                            }
                        },
                        {
                            type: "separator"
                        },
                        {
                            role: "toggledevtools"
                        },
                        {
                            type: "separator"
                        },
                        {
                            label: "Close Project",
                            click: () => {
                                saveGraphAndClose();
                            }
                        }
                    ]
                },
                {
                    label: "Project",
                    submenu: [
                        {
                            label: "Edit Project Information", click: () => {
                                ipcRenderer.send("openProjectInfoEditor");
                            }
                        },
                        {
                            type: "separator"
                        },
                        {
                            label: "Close",
                            click: () => {
                                saveGraphAndClose();
                            }
                        }
                    ]
                },
                {
                    label: "Compile",
                    submenu: [
                        {
                            label: "Generate Code, Compile, Package", click: () => {
                                generateCodeCompilePackage();
                            }
                        },
                        {
                            type: "separator"
                        },
                        {
                            label: "Open output directory", click: () => {
                                ipcRenderer.send("openOutputDir");
                            }
                        },
                        {
                            type: "separator"
                        },
                        {
                            label: "Generate Code", click: () => {
                                generateCode();
                            }
                        },
                        {
                            label: "Compile", click: () => {
                                compile();
                            }
                        },
                        {
                            label: "Package", click: () => {
                                pack();
                            }
                        }
                    ]
                }
            ]))

            ipcRenderer.on("projectInfo", function (event, arg) {
                projectInfo = arg;
                console.log("Project:")
                console.log(arg);
            });
            ipcRenderer.on("graphData", function (event, arg) {
                if (!arg) {
                    console.warn("Empty graph data")
                    return;
                }
                if (graph && arg.nodes) {
                    graph.configure(arg);
                }
                $("#overlay").fadeOut();
            })

        </script>
    </body>
</html>